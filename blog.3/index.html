<!DOCTYPE html><html lang="en"><head><title>Blog | Kevin Sookocheff</title><meta name="description" content="Tinker. Tailor. Soldier. Sailor."><meta name="keywords" content=""><meta name="author" content="Kevin Sookocheff"><!-- Meta--><meta charset="utf-8"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="DocPad v6.64.0" /><!--[if lt IE 9]><script async src="//html5shim.googlecode.com/svn/trunk/html5.js"></script><script async src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.js"></script><![endif]--><!-- Analytics--><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-20611089-6', 'sookocheff.com');
  ga('send', 'pageview');

</script>
<link  rel="stylesheet" href="/vendor/bootstrap.min.css" /><link  rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" /><link  rel="stylesheet" href="/styles/style.css" /><link  rel="stylesheet" href="/styles/monokai.css" /></head><body><!-- Navbar--><div class="navbar navbar-default"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Kevin Sookocheff</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/pages/speaking">Speaking</a></li><li><a href="/blog">Blog</a></li><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle"> 
Subscribe <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="http://eepurl.com/KJE01">email</a></li><li><a href="http://sookocheff.com/rss.xml">RSS</a></li></ul></li></ul></div></div></div><!-- Container--><!-- Container--><div class="container"><!-- Content--><section id="content" class="content"><section class="page"><div class="page-header"><h1>Blog</h1></div><div class="page-content"><article><h2><a href="/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php">Saving canvas data to an image file with JavaScript and PHP</a></h2><small class="text-muted">Posted on <time datetime="2011-6-27">Wednesday, July 27, 2011</time>. </small><div class="post-content"><p>Saving HTML canvas element data to an image in a user friendly manner is a tricky problem.</p>
<h3 id="first-attempt">First Attempt</h3>
<p>We could always open our canvas in a new browser tab (or window) with the <code>toDataURL</code> JavaScript method.</p>
<pre class="highlight"><code class="hljs avrasm">window<span class="hljs-preprocessor">.location</span><span class="hljs-preprocessor">.href</span> = canvas<span class="hljs-preprocessor">.toDataURL</span>(<span class="hljs-string">"image/png"</span>)<span class="hljs-comment">;</span>
</code></pre><p>Unfortunately this requires the user to use the file menu or the right-click button to save the image from the newly opened browser tab. I wouldn’t call this user friendly.</p>
<h3 id="second-attempt">Second Attempt</h3>
<p>After some investigation I came across Nihilogic’s <a href="http://www.nihilogic.dk/labs/canvas2image/"><code>Canvas2Image</code></a> JavaScript package. This package presents a Dialog Box to the user allowing them to save the image. This would solve my problem except the downloaded filename has the format 8iqALWM5.part . If my mom encountered a filename like that she wouldn’t know what to do with it. Still not user friendly.</p>
<h3 id="final-attempt">Final Attempt</h3>
<p>What to do? Enter PHP.</p>
<p><a href="http://www.permadi.com/blog/2010/10/html5-saving-canvas-image-data-using-php-and-ajax/">Permadi</a> presents a technique using PHP and AJAX that is exactly what I need. After some tweaking here’s what I came up with.</p>
<h3 id="save-php">save.php</h3>
<p>The first PHP file saves the passed in canvas data to the server at a random location determined by the md5(uniqid())  method.</p>
<pre class="highlight"><code class="hljs ruby"><span class="hljs-variable">$data</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'data'</span>];
<span class="hljs-variable">$file</span> = md5(uniqid()) . <span class="hljs-string">'.png'</span>;

<span class="hljs-regexp">//</span> remove <span class="hljs-string">"data:image/png;base64,"</span>
<span class="hljs-variable">$uri</span> =  substr(<span class="hljs-variable">$data</span>,strpos(<span class="hljs-variable">$data</span>,<span class="hljs-string">","</span>) <span class="hljs-number">1</span>);

<span class="hljs-regexp">//</span> save to file
file_put_contents(<span class="hljs-variable">$file</span>, base64_decode(<span class="hljs-variable">$uri</span>));

<span class="hljs-regexp">//</span> <span class="hljs-keyword">return</span> the filename
echo json_encode(<span class="hljs-variable">$file</span>);
</code></pre><p>We would call this via JQuery with the $.post method, filling the data parameter using the <code>toDataURL</code> method.</p>
<pre class="highlight"><code class="hljs css">$<span class="hljs-class">.post</span>("<span class="hljs-tag">save</span><span class="hljs-class">.php</span>", <span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">data</span>:<span class="hljs-value"> canvas.<span class="hljs-function">toDataURL(<span class="hljs-string">"image/png"</span>)</span></span></span></span>})
</code></pre><h3 id="download-php">download.php</h3>
<p>Now we can use PHP to force the download of the saved image data. You can read more about this in the <a href="http://php.net/manual/en/function.readfile.php">PHP Manual</a>.</p>
<pre class="highlight"><code class="hljs bash"><span class="hljs-variable">$file</span> = trim(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'path'</span>]);

// force user to download the image
<span class="hljs-keyword">if</span> (file_exists(<span class="hljs-variable">$file</span>)) {
    header(<span class="hljs-string">'Content-Description: File Transfer'</span>);
    header(<span class="hljs-string">'Content-Type: image/png'</span>);
    header(<span class="hljs-string">'Content-Disposition: attachment; filename='</span>.basename(<span class="hljs-variable">$file</span>));
    header(<span class="hljs-string">'Content-Transfer-Encoding: binary'</span>);
    header(<span class="hljs-string">'Expires: 0'</span>);
    header(<span class="hljs-string">'Cache-Control: must-revalidate, post-check=0, pre-check=0'</span>);
    header(<span class="hljs-string">'Pragma: public'</span>);
    header(<span class="hljs-string">'Content-Length: '</span> . filesize(<span class="hljs-variable">$file</span>));
    ob_clean();
    flush();
    readfile(<span class="hljs-variable">$file</span>);
    <span class="hljs-keyword">exit</span>;
}
<span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$file</span> not found"</span>;
}
</code></pre><p>We can use the return value of our first AJAX request as input to <code>download.php</code> to provide the filename.</p>
<pre class="highlight"><code class="hljs javascript">$(<span class="hljs-string">"#save"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    $.post(<span class="hljs-string">"save.php"</span>, {data: G_cv.toDataURL(<span class="hljs-string">"image/png"</span>)}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(file)</span> {</span>
        window.location.href =  <span class="hljs-string">"download.php?path="</span>  file});
    });
</code></pre><p>Now when the <code>Save</code> link is clicked a dialog box will be presented to the user asking them to save their image.</p>
<p>User friendly?</p>
</div><hr/><p>Share this post: <a href="https://twitter.com/intent/tweet?url=http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php&amp;text=Saving canvas data to an image file with JavaScript and PHP&amp;via=soofaloofa"><i class="fa fa-twitter"></i></a>&nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php"><i class="fa fa-facebook"></i></a>&nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php"><i class="fa fa-google-plus"></i></a>&nbsp;&nbsp;<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;<a href="mailto:?subject=Check out this link&amp;body=http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php"><i class="fa fa-envelope"></i></a></p><hr/></article><article><h2><a href="/posts/2011-06-28-using-leiningen-behind-a-windows-proxy">Using Leiningen behind a Windows proxy</a></h2><small class="text-muted">Posted on <time datetime="2011-5-28">Tuesday, June 28, 2011</time>. </small><div class="post-content"><p>I’ve been getting familiar with the <a href="https://github.com/technomancy/leiningen">Leiningen</a> build tool for <a href="http://clojure.org/">Clojure</a> but had trouble connecting to the Clojar and Maven repositories behind a proxy.</p>
<p>I ended up adding my proxy to Maven’s <code>settings.xml</code> and everything worked out.</p>
<p>You can find <code>settings.xml</code>  at <code>C:\apache-maven-X.X.X\conf\settings.xml</code>  and can edit it according to the conventions described <a href="http://maven.apache.org/guides/mini/guide-proxies.html">here</a>.</p>
<p>After editing the file run lein deps  to download your project dependencies. If still can’t connect to the repository servers you may have to copy the <code>settings.xml</code> file to your <code>.m2</code> directory at <code>C:\Documents and Settings\username\.m2\settings.xml</code></p>
</div><hr/><p>Share this post: <a href="https://twitter.com/intent/tweet?url=http://sookocheff.com/posts/2011-06-28-using-leiningen-behind-a-windows-proxy&amp;text=Using Leiningen behind a Windows proxy&amp;via=soofaloofa"><i class="fa fa-twitter"></i></a>&nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://sookocheff.com/posts/2011-06-28-using-leiningen-behind-a-windows-proxy"><i class="fa fa-facebook"></i></a>&nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://sookocheff.com/posts/2011-06-28-using-leiningen-behind-a-windows-proxy"><i class="fa fa-google-plus"></i></a>&nbsp;&nbsp;<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sookocheff.com/posts/2011-06-28-using-leiningen-behind-a-windows-proxy"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;<a href="mailto:?subject=Check out this link&amp;body=http://sookocheff.com/posts/2011-06-28-using-leiningen-behind-a-windows-proxy"><i class="fa fa-envelope"></i></a></p><hr/></article><article><h2><a href="/posts/2011-06-09-date-now-in-ie6">Date.now() in IE6</a></h2><small class="text-muted">Posted on <time datetime="2011-5-9">Thursday, June 09, 2011</time>. </small><div class="post-content"><p>I was fiddling with a JavaScript timer application and noticed a bug in IE6. I’m sure this is documented elsewhere but I couldn’t find anything with some quick searches; hence this post.</p>
<p><code>Date.now()</code> is not supported by IE6. Use <code>new Date().getTime()</code> instead.</p>
</div><hr/><p>Share this post: <a href="https://twitter.com/intent/tweet?url=http://sookocheff.com/posts/2011-06-09-date-now-in-ie6&amp;text=Date.now() in IE6&amp;via=soofaloofa"><i class="fa fa-twitter"></i></a>&nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://sookocheff.com/posts/2011-06-09-date-now-in-ie6"><i class="fa fa-facebook"></i></a>&nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://sookocheff.com/posts/2011-06-09-date-now-in-ie6"><i class="fa fa-google-plus"></i></a>&nbsp;&nbsp;<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sookocheff.com/posts/2011-06-09-date-now-in-ie6"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;<a href="mailto:?subject=Check out this link&amp;body=http://sookocheff.com/posts/2011-06-09-date-now-in-ie6"><i class="fa fa-envelope"></i></a></p><hr/></article><article><h2><a href="/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements">The JavaScript click event and hidden input elements</a></h2><small class="text-muted">Posted on <time datetime="2011-5-2">Thursday, June 02, 2011</time>. </small><div class="post-content"><p>I was recently working with the HTML canvas element and wanted to attach an event to the canvas that would fire the click event of a file input element. I would then hide the input element so that the canvas element was the only way to browse for files. My first attempt was simple enough.</p>
<pre class="highlight"><code class="hljs javascript">document.getElementById(<span class="hljs-string">'canvas'</span>).onclick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    document.getElementById(<span class="hljs-string">'filepicker'</span>).click();
};
</code></pre><p>Now it’s time to hide the filepicker input element. Setting the elements style to display: none worked fine with Firefox but Chrome does not allow click events to be fired from hidden HTML elements. The solution is to use a bit of CSS to effectively hide the element. I came across this method over at <a href="http://www.quirksmode.org/dom/inputfile.html">quirksmode</a> where they use it to style input boxes with CSS. I adapted it to my needs and came up with this solution.</p>
<p>With CSS we set the opacity to <code>0</code> rendering the element invisible. The different declarations are for cross-browser compatibility.</p>
<pre class="highlight"><code class="hljs css"><span class="hljs-class">.fakehidden</span> <span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">-moz-opacity</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">filter</span>:<span class="hljs-value"><span class="hljs-function">alpha(opacity: <span class="hljs-number">0</span>)</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">opacity</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
<span class="hljs-rule">}</span></span>
</code></pre><p>Setting the input elements class tofakehidden  effectively hides the element from the user yet click events can be fired as usual.</p>
</div><hr/><p>Share this post: <a href="https://twitter.com/intent/tweet?url=http://sookocheff.com/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements&amp;text=The JavaScript click event and hidden input elements&amp;via=soofaloofa"><i class="fa fa-twitter"></i></a>&nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://sookocheff.com/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements"><i class="fa fa-facebook"></i></a>&nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://sookocheff.com/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements"><i class="fa fa-google-plus"></i></a>&nbsp;&nbsp;<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sookocheff.com/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;<a href="mailto:?subject=Check out this link&amp;body=http://sookocheff.com/posts/2011-06-02-the-javascript-click-event-and-hidden-input-elements"><i class="fa fa-envelope"></i></a></p><hr/></article><article><h2><a href="/posts/2011-05-18-dissecting-jquerys-fade-animation">Dissecting jQuery's Fade Animation</a></h2><small class="text-muted">Posted on <time datetime="2011-4-18">Wednesday, May 18, 2011</time>. </small><div class="post-content"><p>Fade animations are a standard tool in any jQuery developer’s toolbox. But how do they really work? Let’s create a small function that encapsulates solely the fade functionality and find out.</p>
<p>Let’s start with the jQuery <code>$</code> idiom.</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">$</span><span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">var</span> $ = document.getElementById(id);
    <span class="hljs-keyword">return</span> $;
}
</code></pre><p>This function takes an HTML id as a parameter and returns the element associated with this id. We can call this function with a string to return the particular element we need.</p>
<pre class="highlight"><code class="hljs ruby"><span class="hljs-variable">$(</span><span class="hljs-string">'img'</span>);
</code></pre><p>Let’s add a function to our element.</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">$</span><span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">var</span> $ = document.getElementById(id);

    $.fade = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-comment">// perform fade here</span>
    };

    <span class="hljs-keyword">return</span> $;
}
</code></pre><p>We can call the function by appending <code>.fade</code> to our element.</p>
<pre class="highlight"><code class="hljs ruby"><span class="hljs-variable">$(</span><span class="hljs-string">'img'</span>).fade();
</code></pre><p>Now let’s set up the rest of the function by adding a parameter for the length of the delay and storing a reference to <code>this</code>. In our context <code>this</code> refers to the element we are calling fade from. (For a detailed explanation of how <code>this</code> is set see the <a href="http://javascriptweblog.wordpress.com">JavaScript, JavaScript</a> article <a href="http://javascriptweblog.wordpress.com/.../understanding-javascripts-this/">here</a>). Finally, we set the display style of our element to <code>block</code> to ensure our animation is visible.</p>
<pre class="highlight"><code class="hljs javascript">$.fade = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delay)</span> {</span>
    <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;

    _this.style.display = <span class="hljs-string">'block'</span>;

    <span class="hljs-comment">// perform fade here</span>
};
</code></pre><p>We perform the fade by setting the opacity of our element. For this purpose let’s define a new function for setting the opacity of an element <code>elm</code> to <code>v</code>. We divide by 100 to define our fade in terms of a percentage.</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">var</span> opacityTo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elm, v)</span> {</span>
    elm.style.opacity = v/<span class="hljs-number">100</span>;
};
</code></pre><p>We can add a call to this function to our fade method.</p>
<pre class="highlight"><code class="hljs javascript">$.fade = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delay)</span> {</span>
    <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;

    _this.style.display = <span class="hljs-string">'block'</span>;

    <span class="hljs-comment">// set the opacity to 50%</span>
    opacityTo(_this, <span class="hljs-number">50</span>);
};
</code></pre><p>Now the trick is to call this function to fade the element over a period of time. We do this by using the <code>setTimeout(callbk, delay)</code> function to set the opacity to different values at particular moments in time. The method signature defines a callbk parameter as a function to call when delay time has passed. If we call this function 100 times throughout our animation we will have a smooth and fluid result.</p>
<p>First we set up the <code>for</code> loop to iterate from 1 to 100 and then call an anonymous function sending the index of our loop as a parameter to the function. Our anonymous function then calls <code>setTimeout</code> periodically (100 times in total).</p>
</div><hr/><p>Share this post: <a href="https://twitter.com/intent/tweet?url=http://sookocheff.com/posts/2011-05-18-dissecting-jquerys-fade-animation&amp;text=Dissecting jQuery's Fade Animation&amp;via=soofaloofa"><i class="fa fa-twitter"></i></a>&nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://sookocheff.com/posts/2011-05-18-dissecting-jquerys-fade-animation"><i class="fa fa-facebook"></i></a>&nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://sookocheff.com/posts/2011-05-18-dissecting-jquerys-fade-animation"><i class="fa fa-google-plus"></i></a>&nbsp;&nbsp;<a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sookocheff.com/posts/2011-05-18-dissecting-jquerys-fade-animation"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;<a href="mailto:?subject=Check out this link&amp;body=http://sookocheff.com/posts/2011-05-18-dissecting-jquerys-fade-animation"><i class="fa fa-envelope"></i></a></p><hr/></article><!-- Pagination --><ul class="pager"><li class="previous"><a href="/blog.4">&larr; Older</a></li><li><a href="/archives">Archives</a></li><li class="next"><a href="/blog.2">Newer &rarr; </a></li></ul></div></section></section></div><div class="container"><hr><!-- Footer--><footer><p class="pull-right"><a href="#" class="pull-right">Top</a></p><p>© Kevin Sookocheff</p></footer></div><!-- Scripts--><script defer="defer"  src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script defer="defer"  src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script></body></html>