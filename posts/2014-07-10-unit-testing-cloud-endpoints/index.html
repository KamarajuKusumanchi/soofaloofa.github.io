<!DOCTYPE html>
<html lang="en">
<head>

<title>Unit Testing Cloud Endpoints : sookocheff.com</title>

<meta charset="utf-8">
<meta http-equiv="content-type", content="text/html; charset=utf-8">
<meta name="viewport", content="width=device-width, initial-scale=1.0">

<link rel="canonical" href="http://localhost:1313/posts/2014-07-10-unit-testing-cloud-endpoints/">

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Bree+Serif">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css">

<link rel="stylesheet" href="/css/vendor/bootstrap.min.css">
<link rel="stylesheet" href="/css/vendor/monokai_sublime.css">
<link rel="stylesheet" href="/css/style.css">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-20611089-6', 'sookocheff.com');
  ga('send', 'pageview');
</script>




</head>
<body>

<div class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">Kevin Sookocheff</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/projects/">Projects</a>
        </li>
        <li class="">
          <a href="/posts/">Blog</a>
        </li>
        <li class="dropdown">
          <a href="#" data-toggle="dropdown" class="dropdown-toggle">
            Subscribe <b class="caret"></b>
          </a>
          <ul class="dropdown-menu">
            <li><a href="http://eepurl.com/KJE01">Email</a></li>
            <li><a href="http://sookocheff.com/index.xml">RSS</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</div>


<div class="container page-container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <section class="page">
        <article class="post">
          <h1>Unit Testing Cloud Endpoints</h1>
          <p>
            <small class="text-muted">
              Posted on Thursday, July 10, 2014 · <a href="http://localhost:1313/posts/2014-07-10-unit-testing-cloud-endpoints/#disqus_thread">0 Comments</a>
            </small>
          </p>

          <div class=".post-content">
            

<p>Writing unit tests for App Engine Cloud Endpoints is a fairly straight forward
process. Unfortunately it is not well documented and a few gotchas exist. This
article provides a template you can use to unit test Cloud Endpoints including
full source code for a working example.</p>

<h2 id="the-model:dec1a5006ed54c46077ff2a4372aca9b">The Model</h2>

<p>Let&rsquo;s use a simple User model as the resource being exposed by our API. This
model has two properties &ndash; a username and an email address. The class also
provides <code>to_message</code> function that converts the model to a ProtoRPC Message for
transmission by the Cloud Endpoints API.</p>

<pre><code class="language-python">class User(ndb.Model):
    &quot;&quot;&quot;
    A basic user model.
    &quot;&quot;&quot;
    username = ndb.StringProperty(required=True)
    email = ndb.StringProperty(required=True)

    def to_message(self):
        &quot;&quot;&quot;
        Convert the model to a ProtoRPC messsage.
        &quot;&quot;&quot;
        return UserMessage(id=self.key.id(),
                           username=self.username,
                           email=self.email)


class UserMessage(messages.Message):
    &quot;&quot;&quot;
    A message representing a User model.
    &quot;&quot;&quot;
    id = messages.IntegerField(1)
    username = messages.StringField(2)
    email = messages.StringField(3)
</code></pre>

<h2 id="the-api:dec1a5006ed54c46077ff2a4372aca9b">The API</h2>

<p>To keep things simple the API for this resource provides a single <code>GET</code> endpoint
that returns a <code>UserMessage</code> based on a <code>User</code> in the datastore. We parameterize
our endpoint with an <code>ID_RESOURCE</code> that takes an <code>IntegerField</code> holding the id
of the User resource.</p>

<pre><code>ID_RESOURCE = endpoints.ResourceContainer(message_types.VoidMessage,
                                          id=messages.IntegerField(1, 
                                                                   variant=messages.Variant.INT32, 
                                                                   required=True))
</code></pre>

<p>The API itself has one method, <code>users_get</code>, that returns a user given an id or
<code>404</code> if no user with the specified id exists.</p>

<pre><code>@endpoints.api(name='users', version='v1', description='Users Api')
class UsersApi(remote.Service):

    @endpoints.method(ID_RESOURCE,
                      UserMessage,
                      http_method='GET',
                      path='users/{id}',
                      name='users.get')
    def users_get(self, request):
        entity = User.get_by_id(request.id)
        if not entity:
            message = 'No user with the id &quot;%s&quot; exists.' % request.id
            raise endpoints.NotFoundException(message)

        return entity.to_message()
</code></pre>

<h2 id="the-tests:dec1a5006ed54c46077ff2a4372aca9b">The Tests</h2>

<p>The setup for our tests is similar to many App Engine test cases. We set our
environment and initialize any test stubs we may need.</p>

<pre><code class="language-python">class GaeTestCase(unittest.TestCase):
    &quot;&quot;&quot;
    API unit tests.
    &quot;&quot;&quot;

    def setUp(self):
        super(GaeTestCase, self).setUp()
        tb = testbed.Testbed()
        tb.setup_env(current_version_id='testbed.version')  # Required for the endpoints API
        tb.activate()
        tb.init_all_stubs()
        self.api = UsersApi()  # Set our API under test
        self.testbed = tb

    def tearDown(self):
        self.testbed.deactivate()
        super(GaeTestCase, self).tearDown()
</code></pre>

<p>The actual tests call the endpoints method directly. Endpoint methods that
are set to receive a <code>ResourceContainer</code> expect a <code>CombinedContainer</code> as the
parameter to the function. The <code>ResourceContainer</code> class has a property called
<code>combined_message_class</code> that returns a <code>CombinedContainer</code> class that can be
instantiated and passed to our endpoint. We instantiate our container with the
identifier we expect for our User resource.</p>

<pre><code class="language-python">def test_get_returns_entity(self):
    user = User(username='soofaloofa', email='soofaloofa@example.com')
    user.put()

    container = ID_RESOURCE.combined_message_class(id=user.key.id())
    response = self.api.users_get(container)
    self.assertEquals(response.username, 'soofaloofa')
    self.assertEquals(response.email, 'soofaloofa@example.com')
    self.assertEquals(response.id, user.key.id())
</code></pre>

<p>We can also add a test for the <code>404</code> condition by calling <code>assertRaises</code> on our
endpoint with an identifier that does not correspond to a User resource.</p>

<pre><code class="language-python">def test_get_returns_404_if_no_entity(self):
    container = ID_RESOURCE.combined_message_class(id=1)
    self.assertRaises(endpoints.NotFoundException, self.api.users_get, container)
</code></pre>

<p>Full source code follows.</p>

<pre><code class="language-python">import unittest
import endpoints

from protorpc import remote
from protorpc import messages
from protorpc import message_types
from google.appengine.ext import testbed
from google.appengine.ext import ndb


class User(ndb.Model):
    &quot;&quot;&quot;
    A basic user model.
    &quot;&quot;&quot;
    username = ndb.StringProperty(required=True)
    email = ndb.StringProperty(required=True)

    def to_message(self):
        &quot;&quot;&quot;
        Convert the model to a ProtoRPC messsage.
        &quot;&quot;&quot;
        return UserMessage(id=self.key.id(),
                           username=self.username,
                           email=self.email)


class UserMessage(messages.Message):
    &quot;&quot;&quot;
    A message representing a User model.
    &quot;&quot;&quot;
    id = messages.IntegerField(1)
    username = messages.StringField(2)
    email = messages.StringField(3)

ID_RESOURCE = endpoints.ResourceContainer(message_types.VoidMessage,
                                          id=messages.IntegerField(1, variant=messages.Variant.INT32, required=True))


@endpoints.api(name='users', version='v1', description='Users Api')
class UsersApi(remote.Service):

    @endpoints.method(ID_RESOURCE,
                      UserMessage,
                      http_method='GET',
                      path='users/{id}',
                      name='users.get')
    def users_get(self, request):
        entity = User.get_by_id(request.id)
        if not entity:
            message = 'No user with the id &quot;%s&quot; exists.' % request.id
            print message
            raise endpoints.NotFoundException(message)

        return entity.to_message()


class GaeTestCase(unittest.TestCase):
    &quot;&quot;&quot;
    API unit tests.
    &quot;&quot;&quot;

    def setUp(self):
        super(GaeTestCase, self).setUp()
        tb = testbed.Testbed()
        tb.setup_env(current_version_id='testbed.version')
        tb.activate()
        tb.init_all_stubs()
        self.api = UsersApi()
        self.testbed = tb

    def tearDown(self):
        self.testbed.deactivate()
        super(GaeTestCase, self).tearDown()

    def test_get_returns_entity(self):
        user = User(username='soofaloofa', email='soofaloofa@example.com')
        user.put()

        container = ID_RESOURCE.combined_message_class(id=user.key.id())
        response = self.api.users_get(container)
        self.assertEquals(response.username, 'soofaloofa')
        self.assertEquals(response.email, 'soofaloofa@example.com')
        self.assertEquals(response.id, user.key.id())

    def test_get_returns_404_if_no_entity(self):
        container = ID_RESOURCE.combined_message_class(id=1)
        self.assertRaises(endpoints.NotFoundException, self.api.users_get, container)
</code></pre>
 
          </div>

          <hr>
            <ul class="list-inline">
  <li>Share this post:</li>
  <li>
    <a href="https://twitter.com/intent/tweet?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2014-07-10-unit-testing-cloud-endpoints%2f&text=Unit%20Testing%20Cloud%20Endpoints&via=soofaloofa">
      <i class="fa fa-twitter fa-lg"></i>
    </a>
  </li>
  <li>
    <a href="https://facebook.com/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2014-07-10-unit-testing-cloud-endpoints%2f">
      <i class="fa fa-facebook fa-lg"></i>
    </a>
  </li>
  <li>
    <a href="https://plus.google.com/share?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2014-07-10-unit-testing-cloud-endpoints%2f">
      <i class="fa fa-google-plus fa-lg"></i>
    </a>
  </li>
  <li>
    <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2014-07-10-unit-testing-cloud-endpoints%2f">
      <i class="fa fa-linkedin fa-lg"></i>
    </a>
  </li>
  <li>
    <a href="mailto:?subject=Check out this link&body=http%3a%2f%2flocalhost%3a1313%2fposts%2f2014-07-10-unit-testing-cloud-endpoints%2f">
      <i class="fa fa-envelope fa-lg"></i>
    </a>
  </li>
</ul>

          <hr>

          <div class="donation">
            <p>Think this post was worth a dollar? If so, I'd love to have it. Support this site quickly and easily using the Paypal button below.</p>

            <div class="row">
              <div class="col-md-10 col-md-offset-5">
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="44DHX3GQMER48">
<table>
<tr><td><input type="hidden" name="on0" value="Amount of Support:">Amount of Support:</td></tr><tr><td><select name="os0">
	<option value="Hat Tip">Hat Tip $1.00 CAD</option>
	<option value="Coffee">Coffee $5.00 CAD</option>
	<option value="Beer">Beer $10.00 CAD</option>
	<option value="Lunch">Lunch $50.00 CAD</option>
	<option value="Dinner">Dinner $100.00 CAD</option>
</select> </td></tr>
</table>
<input type="hidden" name="currency_code" value="CAD">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_paynow_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>

              </div>
            </div>
          </div>

          <hr>

          <div class="blurb">
            <div class="row">
              <div class="col-md-10 col-md-offset-1">
                <h4 class="text-center">About Kevin Sookocheff</h4>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 col-md-offset-1">
                <p>
                  <img class="img-circle center-block" src="/img/profile.png">
                </p>
              </div>
              <div class="col-md-6">
                <p>
                  I am a Software Developer. I work at <a
  href="http://www.vendasta.com">VendAsta</a> with a bunch of great people. I
run a business as <a href="http://redfinchsoftware.com">Red Finch Software</a>.
You can find me online as <a
href="https://twitter.com/soofaloofa">soofaloofa</a>. I love to teach, learn,
speak, and write about business and software. 

                  <ul class="list-inline">
                    <li>On the web:</li>
                    <li><a href="http://www.twitter.com/soofaloofa"><i class="fa fa-twitter-square fa-lg"></i></a></li>
                    <li><a href="http://www.facebook.com/kevin.sookocheff"><i class="fa fa-facebook-square fa-lg"></i></a></li>
                    <li><a href="http://www.linkedin.com/in/kevinsookocheff"><i class="fa fa-linkedin-square fa-lg"></i></a></li>
                    <li><a href="https://github.com/soofaloofa"><i class="fa fa-github-square fa-lg"></i></a></li>
                    <li><a href="http://sookocheff.com/rss.xml"><i class="fa fa-rss-square fa-lg"></i></a></li>
                  </ul>
                </p>
              </div>
            </div>
          </div>
          <hr>

          <div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'kevinsookocheff'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        </article>
      </section>
    </div>
  </div>
</div>

<footer>
 <div class="footer-above text-center">
   <div class="container">
     <div class="row">
       <div class="footer-col col-md-3">
         <h3>App Engine</h3>
         <ul class="list-unstyled">
           <li><a href="/series/mapreduce-api/">MapReduce API</a></li>
           <li><a href="/series/pipelines-api/">Pipelines API</a></li>
           <li><a href="/series/cloud-endpoints/">Cloud Endpoints</a></li>
         </ul>
       </div>

       <div class="footer-col col-md-3">
         <h3>APIs</h3>
         <ul class="list-unstyled">
           <li>
             <a href="/posts/2014-03-11-on-choosing-a-hypermedia-format/">On Choosing a Hypermedia Format</a>
           </li>
           <li>
             <a href="/posts/2014-03-27-when-to-use-http-put-and-http-post/">When to use HTTP PUT</a>
           </li>
         </ul>
       </div>

       <div class="footer-col col-md-3">
         <h3>Random</h3>
         <ul class="list-unstyled">
           <li>
           <a href="http://sookocheff.com/posts/2013-04-09-submitting-a-unity3d-game-to-the-mac-app-store/"> Unity3d on the Mac App Store</a>
           </li>
           <li>
             <a href="http://sookocheff.com/posts/2011-07-27-saving-canvas-data-to-an-image-file-with-javascript-and-php/">Saving Canvas Data to an Image</a>
           </li>
         </ul>
       </div>

       <div class="footer-col col-md-3">
         <h3>Social</h3>
         <ul class="list-unstyled">
           <li><a href="http://www.twitter.com/soofaloofa">Twitter</a></li>
           <li><a href="http://www.facebook.com/kevin.sookocheff">Facebook</a></li>
           <li><a href="http://www.linkedin.com/in/kevinsookocheff">LinkedIn</a></li>
           <li><a href="https://plus.google.com/+KevinSookocheff">Google+</a></li>
           <li><a href="https://github.com/soofaloofa">Github</a></li>
         </ul>
       </div>
     </div>
   </div>
 </div>
 <div class="footer-below text-center">
     <div class="container">
         <div class="row">
             <div class="col-lg-12">
                 &copy; Kevin Sookocheff · <a href="#">Top</a>
             </div>
         </div>
     </div>
 </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
<script src="/js/vendor/retina.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
 
var disqus_shortname = 'kevinsookocheff'; 

 
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

